#!/bin/bash
set -euo pipefail

SRC=/opt/filebrowser/masso
DST=/opt/masso_images
SIZE=512M
SIG="$DST/.last_commit.sig"

mkdir -p "$DST"
[ -d "$SRC" ] || { echo "ERROR: $SRC missing"; exit 1; }

/usr/local/bin/masso-detach

CURR=$(readlink -f "$DST/current.img" 2>/dev/null || true)
if [[ "$CURR" == "$DST/massoA.img" ]]; then
  NEW="$DST/massoB.img"
else
  NEW="$DST/massoA.img"
fi

losetup -j "$NEW" | cut -d: -f1 | xargs -r losetup -d || true

fallocate -l "$SIZE" "$NEW"
mkfs.vfat -F32 -n MASSOUSB "$NEW"

TMP=$(mktemp -d /tmp/masso_build.XXXXXX)
cleanup(){ umount "$TMP" 2>/dev/null || true; rmdir "$TMP" 2>/dev/null || true; }
trap cleanup EXIT

mount -o loop "$NEW" "$TMP"
rsync -rltD --delete --no-owner --no-group "$SRC"/ "$TMP"/
sync
umount "$TMP"; rmdir "$TMP"; trap - EXIT

ln -sfn "$NEW" "$DST/current.img"
sync

sig=$(find "$SRC" -type f -printf '%P\t%T@\t%s\n' | LC_ALL=C sort | sha256sum | awk '{print $1}')
printf '%s\n' "${sig:-0000000000000000000000000000000000000000000000000000000000000000}" > "$SIG"

sleep 0.5
/usr/local/bin/masso-attach
