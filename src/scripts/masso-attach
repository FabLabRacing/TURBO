#!/bin/bash
set -euo pipefail
G=/sys/kernel/config/usb_gadget/masso
IMG=/opt/masso_images/current.img

if [ ! -d "$G" ]; then
  /usr/local/bin/masso-gadget-init
fi

echo "$IMG" | tee "$G/functions/mass_storage.usb0/lun.0/file" >/dev/null

UDC=$(ls /sys/class/udc | head -n1 || true)
[ -n "$UDC" ] || { echo "No UDC"; exit 1; }
echo "$UDC" | tee "$G/UDC" >/dev/null
echo "Attached on $UDC with $IMG"
